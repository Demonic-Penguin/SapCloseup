{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-lg border-0 rounded-lg mt-4">
            <div class="card-header bg-primary text-white text-center py-4">
                <h1 class="display-5">
                    <i class="fas fa-cog me-3 animated-icon"></i>
                    SAP Connection Settings
                </h1>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <p class="lead">Configure your SAP connection settings</p>
                    <p>Use this page to switch between mock data mode and real SAP connection.</p>
                </div>
                
                <form method="POST" id="configForm" class="needs-validation" novalidate>
                    <div class="mb-4">
                        <label for="connection_type" class="form-label">Connection Type:</label>
                        <select class="form-select form-select-lg" id="connection_type" name="connection_type" required>
                            <option value="mock" {% if current_config.connection_type == 'mock' %}selected{% endif %}>Mock Data (Development Mode)</option>
                            <option value="api" {% if current_config.connection_type == 'api' %}selected{% endif %}>Real SAP Connection (via API Adapter)</option>
                            <option value="local" {% if current_config.connection_type == 'local' %}selected{% endif %}>Local SAP Connection (Script Generation)</option>
                            <option value="direct" {% if current_config.connection_type == 'direct' %}selected{% endif %}>Direct SAP Connection (Windows Only)</option>
                        </select>
                        <div class="form-text">
                            <ul class="pt-2">
                                <li><strong>Mock Data:</strong> Use for testing without SAP</li>
                                <li><strong>API Adapter:</strong> Use an API server on Windows to control SAP GUI</li>
                                <li><strong>Local Connection:</strong> Generate VBS scripts to run directly on your Windows machine</li>
                                <li><strong>Direct Connection:</strong> Directly control SAP GUI without scripts or APIs (Windows only)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="apiSettings" class="{% if current_config.connection_type != 'api' %}d-none{% endif %}">
                        <div class="mb-4">
                            <label for="api_url" class="form-label">SAP API URL:</label>
                            <input type="url" class="form-control form-control-lg" id="api_url" name="api_url" 
                                   value="{{ current_config.api_url }}" placeholder="http://windows-machine-ip:5001/api/sap">
                            <div class="form-text">
                                The URL of the SAP API adapter running on your Windows machine with SAP GUI.
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="api_key" class="form-label">SAP API Key:</label>
                            <input type="password" class="form-control form-control-lg" id="api_key" name="api_key" 
                                   value="{{ current_config.api_key }}" placeholder="Enter your API key">
                            <div class="form-text">
                                The API key for authentication with the SAP API adapter.
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>
                            Save Configuration
                        </button>
                    </div>
                </form>
                
                <div class="card border-light mt-5">
                    <div class="card-body">
                        <h5 class="card-title text-primary">
                            <i class="fas fa-info-circle me-2"></i>
                            Setup Instructions
                        </h5>
                        
                        <ul class="nav nav-tabs" id="setupTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-content" type="button" role="tab">
                                    API Connection
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-content" type="button" role="tab">
                                    Local Scripts
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="direct-tab" data-bs-toggle="tab" data-bs-target="#direct-content" type="button" role="tab">
                                    Direct Connection
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content p-3 border border-top-0 rounded-bottom">
                            <div class="tab-pane fade show active" id="api-content" role="tabpanel">
                                <h6 class="mb-3">API Connection Setup</h6>
                                <p>To connect to a real SAP system via API, you need to:</p>
                                <ol>
                                    <li>Set up the SAP API adapter on a Windows machine with SAP GUI</li>
                                    <li>Configure the adapter with the same API key entered here</li>
                                    <li>Ensure SAP GUI is open and logged in on the Windows machine</li>
                                    <li>Make sure the Windows machine is network-accessible from this server</li>
                                </ol>
                            </div>
                            
                            <div class="tab-pane fade" id="local-content" role="tabpanel">
                                <h6 class="mb-3">Local Scripts Setup</h6>
                                <p>The local connection mode works by generating VBS scripts that you run directly on your Windows machine:</p>
                                <ol>
                                    <li>Set the connection mode to "Local SAP Connection"</li>
                                    <li>Process a service order in the application</li> 
                                    <li>Download the generated VBS script</li>
                                    <li>Run the script on your Windows machine with SAP GUI installed</li>
                                    <li>The script will automate the SAP GUI actions needed for that step</li>
                                </ol>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> You'll need to have SAP GUI installed with scripting enabled on your Windows machine.
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="direct-content" role="tabpanel">
                                <h6 class="mb-3">Direct Connection Setup</h6>
                                <p>The direct connection mode provides seamless automation without requiring script downloads:</p>
                                <ol>
                                    <li>This application must be running on a Windows machine with SAP GUI installed</li>
                                    <li>SAP GUI must have scripting enabled (see instructions below)</li>
                                    <li>SAP GUI should be open with an active connection before using this application</li>
                                    <li>Set the connection mode to "Direct SAP Connection"</li>
                                    <li>The application will directly control SAP GUI without any script downloads</li>
                                </ol>
                                
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Important:</strong> This mode only works when running this application on Windows with SAP GUI installed. On other platforms, it will fall back to mock data mode.
                                </div>
                                
                                <div class="card bg-light mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">How to Enable SAP GUI Scripting</h6>
                                    </div>
                                    <div class="card-body">
                                        <p>Follow these steps to enable SAP GUI Scripting:</p>
                                        <ol>
                                            <li>Open SAP GUI</li>
                                            <li>Go to "Customize Local Layout" (Alt+F12)</li>
                                            <li>Select the "Scripting" tab</li>
                                            <li>Check "Enable Scripting"</li>
                                            <li>Uncheck "Notify when a script attaches to a running SAP GUI"</li>
                                            <li>Click "OK" to save the settings</li>
                                            <li>Restart SAP GUI</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Troubleshooting:</strong> If you encounter COM interface or "Invalid class string" errors, try restarting SAP GUI, ensuring you have an active session open, or checking with your SAP administrator about scripting permissions. Some corporate SAP installations restrict scripting capabilities.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <p>See the <a href="{{ url_for('download_script', filename='SAP_INTEGRATION_GUIDE.md') if config.SAP_CONNECTION_TYPE == 'local' else '#' }}" target="_blank">integration guide</a> for detailed setup instructions.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const connectionType = document.getElementById('connection_type');
    const apiSettings = document.getElementById('apiSettings');
    
    connectionType.addEventListener('change', function() {
        if (connectionType.value === 'api') {
            apiSettings.classList.remove('d-none');
        } else {
            apiSettings.classList.add('d-none');
        }
    });
});
</script>
{% endblock %}
{% endblock %}